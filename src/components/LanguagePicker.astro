---
import { languages } from '../i18n/ui';
import { getLangFromUrl } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);

const flags = {
  es: { src: 'https://flagcdn.com/w40/es.png', alt: 'Espa√±a' },
  en: { src: 'https://flagcdn.com/w40/us.png', alt: 'USA' },
  fr: { src: 'https://flagcdn.com/w40/fr.png', alt: 'France' },
};
---

<div class="relative inline-block text-left" id="language-picker">
  <button
    type="button"
    id="language-btn"
    class="inline-flex items-center justify-center w-full gap-2 rounded-md border border-outline-light/30 dark:border-outline-dark/30 bg-surface-light/50 dark:bg-surface-dark/50 px-3 py-2 text-sm font-medium text-on-surface-light dark:text-on-surface-dark shadow-sm hover:bg-surface-light hover:dark:bg-surface-dark focus:outline-none focus:ring-2 focus:ring-primary-light dark:focus:ring-primary-dark transition-all duration-200"
    aria-expanded="false"
    aria-haspopup="true"
  >
    <img 
      src={flags[lang as keyof typeof flags].src} 
      alt={flags[lang as keyof typeof flags].alt}
      class="w-5 h-auto object-cover rounded-sm"
    />
    <span class="uppercase">{lang}</span>
    <svg class="-mr-1 h-5 w-5 text-outline-light dark:text-outline-dark" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
      <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 11.168l3.71-3.938a.75.75 0 111.08 1.04l-4.25 4.5a.75.75 0 01-1.08 0l-4.25-4.5a.75.75 0 01.02-1.06z" clip-rule="evenodd" />
    </svg>
  </button>

  <div
    id="language-menu"
    class="absolute right-0 z-10 mt-2 w-36 origin-top-right rounded-md bg-surface-light dark:bg-surface-dark shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none opacity-0 invisible transform scale-95 transition-all duration-200"
    role="menu"
    aria-orientation="vertical"
    aria-labelledby="language-btn"
  >
    <div class="py-1" role="none">
      {Object.entries(languages).map(([label, name]) => (
        <a
          href={`/${label}/`}
          class={`flex items-center gap-3 px-4 py-2 text-sm text-on-surface-light dark:text-on-surface-dark hover:bg-black/5 dark:hover:bg-white/10 ${lang === label ? 'bg-primary-light/10 dark:bg-primary-dark/10 font-bold' : ''}`}
          role="menuitem"
        >
          <img 
            src={flags[label as keyof typeof flags].src} 
            alt={flags[label as keyof typeof flags].alt}
            class="w-5 h-auto object-cover rounded-sm" 
          />
          <span>{name}</span>
        </a>
      ))}
    </div>
  </div>
</div>

<script>
  const picker = document.getElementById('language-picker');
  const btn = document.getElementById('language-btn');
  const menu = document.getElementById('language-menu');

  if (picker && btn && menu) {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const isExpanded = btn.getAttribute('aria-expanded') === 'true';
      
      if (isExpanded) {
        closeMenu();
      } else {
        openMenu();
      }
    });

    // Close when clicking outside
    document.addEventListener('click', (e) => {
      if (!picker.contains(e.target as Node)) {
        closeMenu();
      }
    });

    // Handle pressing Escape
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeMenu();
      }
    });
  }

  function openMenu() {
    const btn = document.getElementById('language-btn');
    const menu = document.getElementById('language-menu');
    if (!btn || !menu) return;

    btn.setAttribute('aria-expanded', 'true');
    menu.classList.remove('opacity-0', 'invisible', 'scale-95');
    menu.classList.add('opacity-100', 'visible', 'scale-100');
  }

  function closeMenu() {
    const btn = document.getElementById('language-btn');
    const menu = document.getElementById('language-menu');
    if (!btn || !menu) return;

    btn.setAttribute('aria-expanded', 'false');
    menu.classList.add('opacity-0', 'invisible', 'scale-95');
    menu.classList.remove('opacity-100', 'visible', 'scale-100');
  }
</script>
